# Cockpit Docker Manager - Debian Packaging

Debian packaging repository for cockpit-dockermanager.

**Local Instructions**: For environment-specific instructions and configurations, see @CLAUDE.local.md (not committed to version control).

## Git Workflow Policy

**Branch Workflow:** Never push to main directly - always use feature branches and PRs.

## Purpose

This repository contains only Debian packaging files for building .deb packages of cockpit-dockermanager. The upstream source is maintained separately at https://github.com/chrisjbawden/cockpit-dockermanager.

## Structure

- `debian/` - Standard Debian packaging directory
  - `control` - Package metadata and dependencies
  - `rules` - Build instructions (uses dh with minimal overrides)
  - `changelog` - Version history in Debian format
  - `copyright` - License information (machine-readable format)
  - `install` - File installation mappings
  - `compat` - Debhelper compatibility level (13)
  - `source/format` - Source package format (3.0 quilt)

## Building

The build process expects the upstream source to be cloned as `cockpit-dockermanager/` in this directory:

```bash
git clone https://github.com/chrisjbawden/cockpit-dockermanager.git
dpkg-buildpackage -us -uc -b
```

## Package Details

- Package name: cockpit-dockermanager
- Architecture: all (pure JavaScript/HTML/CSS)
- Dependencies: cockpit (>= 200)
- Recommends: docker.io | docker-ce
- Installation path: /usr/share/cockpit/dockermanager/

## Version Management

**Version System:** Unified HaLOS versioning with auto-incrementing revisions.

### Version Components

**VERSION file** (canonical source):
- Contains upstream version only (e.g., `1.0.7` or `1.0.7.2`)
- Accepts both 3-part and 4-part semver formats
- No 'v' prefix, no revision
- Tracks upstream cockpit-dockermanager version
- Automatically updated by `check-upstream-version.yml` workflow

**Git tags** (auto-generated by CI):
- Pre-release: `v{upstream}+{N}_pre` (unstable channel, DEP-14 compliant)
- Stable: `v{upstream}+{N}` (stable channel)
- N = auto-calculated from existing git tags
- Note: Underscore used instead of tilde for git tag validity

**Debian package version**:
- Format: `{upstream}-{N}`
- Generated dynamically by CI in `debian/changelog`

**Example version progression**:
```
Git tags:    v1.0.7+1_pre < v1.0.7+1 < v1.0.7+2_pre < v1.0.7+2 < v1.0.8+1_pre < v1.0.8+1
Debian pkgs: 1.0.7-1      = 1.0.7-1 < 1.0.7-2      = 1.0.7-2 < 1.0.8-1      = 1.0.8-1
```
Note: Same .deb binary (1.0.7-N) is used for both pre-release and stable tags

### Version Bump Workflow

**To bump the upstream version:**

```bash
# Edit VERSION file manually to match upstream release
echo "1.0.8" > VERSION

# Commit the change
git add VERSION
git commit -m "chore: bump version to 1.0.8"
git push origin main
```

**What happens automatically:**
1. CI reads VERSION file
2. CI calculates next revision number (N)
3. CI generates `debian/changelog` with version `{upstream}-{N}`
4. CI builds .deb package
5. CI creates pre-release tag `v{upstream}+{N}_pre` with .deb
6. CI creates draft release tag `v{upstream}+{N}` with .deb
7. CI dispatches to apt.hatlabs.fi unstable channel

**To publish a stable release:**
1. Test the unstable package
2. Publish the draft release in GitHub UI
3. `release.yml` dispatches to apt.hatlabs.fi stable channel

### Key Benefits

✅ Auto-incrementing revisions (no manual coordination)
✅ Same .deb binary for unstable and stable
✅ Monotonic version ordering (each build > previous)
✅ Works with semver, date-based, or arbitrary versions
✅ Git-compliant tag names (DEP-14 standard)

### Rebuild Scenario

If you need to rebuild without changing the upstream version:
1. Just push to main
2. CI auto-increments the revision number
3. New build gets version `{upstream}-{N+1}`

### Version Scripts

**`.github/scripts/calculate-revision.sh`**: Query git tags to find next N
**`.github/scripts/generate-changelog.sh`**: Generate debian/changelog dynamically
**`.github/scripts/test-version-handling.sh`**: Test version format and DEP-14 compliance

### DEP-14 Compliance

Git tags follow [DEP-14](https://dep-team.pages.debian.net/deps/dep14/) version mangling:
- Underscore (`_`) in git tags represents tilde (`~`) in Debian versions
- Since we use the same .deb for both channels, no unmangling is needed
- Pre-release tags use `_pre` suffix (git-valid) instead of `~pre` (git-invalid)

## Maintainer

Matti Airas <matti.airas@hatlabs.fi>
