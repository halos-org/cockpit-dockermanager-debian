name: PR Validation

on:
  pull_request:
    branches: [main]

jobs:
  # Validate package builds on PRs (artifacts not used - fresh build on merge)
  validate-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Clone upstream source
      run: |
        ./run setup:clone

    - name: Auto-increment version and update changelog
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Read upstream version from VERSION file
        UPSTREAM_VERSION=$(cat VERSION)
        echo "Upstream version: $UPSTREAM_VERSION"

        # Find the next available revision number
        REVISION=1
        while gh release view "v${UPSTREAM_VERSION}-${REVISION}" &>/dev/null; do
          echo "Release v${UPSTREAM_VERSION}-${REVISION} exists, trying next..."
          REVISION=$((REVISION + 1))
        done

        PACKAGE_VERSION="${UPSTREAM_VERSION}-${REVISION}"
        echo "Package version will be: $PACKAGE_VERSION"

        # Generate debian/changelog entry
        TIMESTAMP=$(date -R)
        cat > debian/changelog << EOF
        cockpit-dockermanager ($PACKAGE_VERSION) trixie; urgency=medium

          * Automated release v$PACKAGE_VERSION
          * Cockpit Docker Manager upstream version: v$UPSTREAM_VERSION
          * For detailed changes: https://github.com/${{ github.repository }}/commits/main

         -- Hat Labs <info@hatlabs.fi>  $TIMESTAMP
        EOF

        echo "Generated debian/changelog:"
        cat debian/changelog

    - name: Read version from debian/changelog
      id: version
      run: |
        # Extract version from first line of debian/changelog (includes Debian revision)
        VERSION=$(dpkg-parsechangelog -S Version)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Found version: $VERSION"

    - name: Build packages
      run: |
        # Use the CI-specific package build function
        ./run package:deb:docker:ci

    - name: Verify package was built
      run: |
        # Just verify the package exists (no need to upload - will rebuild on merge)
        find . .. -maxdepth 1 -name "*.deb" | head -1 || (echo "ERROR: No .deb package found!" && exit 1)
        echo "âœ… Package build successful"
